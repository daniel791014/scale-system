# 📦 SQL 資料庫遷移說明

## 概述

系統已從 CSV 檔案遷移到 SQLite 資料庫，提供更好的資料一致性、效能和可靠性。

## 🎯 遷移步驟

### 1. 備份現有資料

在執行遷移前，請先備份所有 CSV 檔案：

```bash
# 在伺服器端執行
# 將以下檔案複製到備份資料夾：
# - db_products.csv
# - db_orders.csv
# - db_logs.csv
# - db_line_status.json
```

### 2. 執行遷移腳本

在伺服器端執行遷移腳本：

```bash
python migrate_to_sql.py
```

遷移腳本會：
- 自動建立 SQLite 資料庫結構
- 將所有 CSV 資料匯入 SQL 資料庫
- 產生 `production_db.sqlite` 檔案

### 3. 驗證遷移結果

檢查以下項目：
- ✅ `production_db.sqlite` 檔案已產生
- ✅ 資料筆數與 CSV 檔案一致
- ✅ 啟動系統確認資料正常顯示

### 4. 測試系統

1. 啟動 Streamlit 應用程式
2. 檢查產品資料是否正常顯示
3. 檢查工單資料是否正常顯示
4. 測試新增一筆生產紀錄，確認可以正常儲存

## 📁 資料庫檔案位置

- **SQL 資料庫**：`production_db.sqlite`（位於伺服器共享資料夾）
- **狀態檔案**：`db_line_status.json`（仍使用 JSON 格式）

## ⚠️ 注意事項

1. **首次遷移**：遷移只需執行一次，之後系統會自動使用 SQL 資料庫
2. **保留備份**：建議保留 CSV 檔案作為備份，確認系統穩定運作後再考慮刪除
3. **多用戶存取**：SQLite 支援多用戶讀取，但同時寫入時會自動處理鎖定
4. **資料庫大小**：SQLite 資料庫檔案會隨著資料增加而變大，這是正常現象

## 🔄 回退到 CSV（如需要）

如果遇到問題需要回退：

1. 停止所有 Streamlit 應用程式
2. 將 `data_loader.py` 中的 SQL 相關程式碼改回 CSV 讀寫
3. 使用備份的 CSV 檔案恢復資料

## 📊 資料庫結構

### products 表（產品資料）
- 產品ID、客戶名、溫度等級、品種、密度、尺寸、重量範圍、備註等

### work_orders 表（工單資料）
- 產線、排程順序、工單號碼、產品ID、狀態、數量等

### production_logs 表（生產紀錄）
- 時間、產線、工單號、產品ID、實測重、判定結果、NG原因等

## 🛠️ 維護建議

1. **定期備份**：定期備份 `production_db.sqlite` 檔案
2. **監控大小**：如果資料庫檔案過大（>100MB），可以考慮清理舊資料
3. **效能優化**：SQLite 已建立索引，查詢效能應該良好

## ❓ 常見問題

**Q: 遷移後 CSV 檔案還會被使用嗎？**
A: 不會，系統已完全改用 SQL 資料庫。CSV 檔案可以作為備份保留。

**Q: 多台平板同時寫入會有問題嗎？**
A: SQLite 會自動處理並發寫入，使用檔案鎖定機制確保資料一致性。

**Q: 如何查看資料庫內容？**
A: 可以使用 SQLite 瀏覽器工具（如 DB Browser for SQLite）開啟 `production_db.sqlite` 檔案。

