# 📱 平板電腦部署指南

## 📋 部署架構說明

- **伺服器電腦**：存放共享 SQLite 資料庫檔案（`production_db.sqlite`）和狀態檔案（`db_line_status.json`）
- **四台平板電腦**：運行 Streamlit 應用程式，連接磅秤，透過網路共享資料夾讀寫 SQL 資料庫

> **注意**：系統已從 CSV 檔案遷移到 SQLite 資料庫，提供更好的資料一致性和效能。

---

## ✅ 平板電腦需要安裝的檔案

### 1. **完整專案資料夾**（必須）

將整個專案資料夾複製到每台平板電腦，包含以下所有檔案：

```
📁 磅秤試作(拆)/
├── 📄 main.py                    # 主程式（完整版）
├── 📄 main_refactored.py          # 主程式（重構版，推薦使用）
├── 📄 config.py                  # ⚠️ 重要：需要修改 COM Port
├── 📄 data_manager.py             # 資料管理模組
├── 📄 data_loader.py              # 資料載入模組（已改用 SQL）
├── 📄 db_schema.py                # SQL 資料庫結構定義
├── 📄 migrate_to_sql.py           # CSV 遷移到 SQL 的腳本（首次遷移用）
├── 📄 ui_styles.py                # UI 樣式模組
├── 📄 dialogs.py                  # 對話框模組（如有）
├── 📄 啟動系統.bat                # ⚠️ 重要：啟動腳本
├── 📁 pages/                      # 頁面模組資料夾
│   ├── __init__.py
│   ├── admin.py
│   └── production.py
└── 📁 __pycache__/                # Python 快取（可選）
```

### 2. **不需要複製的檔案**（資料庫檔案會從伺服器讀取）

以下檔案**不需要**複製到平板，它們會自動從伺服器共享資料夾讀取：

- ❌ `production_db.sqlite`（SQL 資料庫檔案）
- ❌ `db_line_status.json`（產線狀態檔案）

> **舊版 CSV 檔案**（如果存在，可作為備份保留）：
> - `db_products.csv`
> - `db_orders.csv`
> - `db_logs.csv`

---

## 🔧 每台平板的設定步驟

### 步驟 1：安裝 Python 環境

1. 安裝 **Python 3.8 或以上版本**
2. 安裝必要的套件：
```bash
pip install streamlit pandas pyserial openpyxl xlsxwriter sqlite3
```
> **注意**：`sqlite3` 通常已包含在 Python 標準庫中，無需額外安裝。如果遇到問題，請確認 Python 版本。

### 步驟 2：修改 `config.py`（每台平板都需要設定）

開啟 `config.py`，根據每台平板連接的磅秤，修改以下設定：

```python
# 第 37 行：修改為該平板連接的 COM Port
SCALE_PORT = "COM5"  # ⚠️ 改為實際的 COM Port（例如 COM3, COM4, COM6...）

# 第 40 行：確認傳輸速率（通常不需要改）
SCALE_BAUDRATE = 9600

# 第 45 行：確認是否使用模擬模式（正式環境應為 False）
USE_SIMULATION = False
```

**重要**：每台平板的 `SCALE_PORT` 可能不同，請根據實際連接的 COM Port 修改。

### 步驟 3：確認網路連線設定

確認 `config.py` 中的伺服器設定正確：

```python
# 第 7 行：伺服器 IP（通常不需要改）
SERVER_IP = "172.16.3.155"

# 第 10 行：共享資料夾名稱（通常不需要改）
SHARED_FOLDER = "GEMINI TEST2"
```

### 步驟 4：修改 `啟動系統.bat`（如果需要）

如果伺服器的帳號密碼不同，請修改 `啟動系統.bat` 第 11 行：

```batch
net use \\172.16.3.155\IPC$ /user:test 0508
```

將 `test` 和 `0508` 改為實際的帳號和密碼。

---

## 🚀 啟動系統

### 方法 1：使用批次檔（推薦）

1. 雙擊 `啟動系統.bat`
2. 系統會自動：
   - 建立網路連線到伺服器
   - 啟動 Streamlit 應用程式
   - 開啟瀏覽器顯示系統介面

### 方法 2：手動啟動

1. 開啟命令提示字元（CMD）或 PowerShell
2. 切換到專案資料夾：
```bash
cd C:\路徑\到\磅秤試作(拆)
```

3. 先建立網路連線：
```bash
net use \\172.16.3.155\IPC$ /user:test 0508
```

4. 啟動 Streamlit：
```bash
streamlit run main_refactored.py
```

---

## 📍 工作站鎖定設定

每台平板啟動後，在側邊欄選擇「📍 鎖定本機工作站」：

- **Line 1 平板**：選擇 `Line 1`
- **Line 2 平板**：選擇 `Line 2`
- **Line 3 平板**：選擇 `Line 3`
- **Line 4 平板**：選擇 `Line 4`

這樣可以讓每台平板只顯示對應產線的資訊，避免混淆。

---

## ⚠️ 常見問題排除

### 問題 1：無法連接到伺服器

**症狀**：系統顯示「⚠️ [單機模式] 找不到伺服器」

**解決方法**：

#### 步驟 1：使用診斷工具測試連線

1. 在平板上執行 `測試伺服器連線.bat`
2. 診斷工具會自動檢查：
   - 網路連通性（ping 測試）
   - 網路連線建立（IPC$ 連線）
   - 共享資料夾存取權限
   - 列出共享資料夾內容

#### 步驟 2：手動測試連線

如果診斷工具顯示錯誤，請依序執行以下命令：

```bash
# 1. 測試網路連通性
ping 172.16.3.155

# 2. 刪除舊連線（如果有）
net use \\172.16.3.155\IPC$ /delete /y

# 3. 建立新連線
net use \\172.16.3.155\IPC$ /user:test 0508

# 4. 測試共享資料夾存取
dir "\\172.16.3.155\GEMINI TEST2"

# 5. 查看伺服器上的所有共享資料夾（如果上述失敗）
net view \\172.16.3.155
```

#### 步驟 3：檢查設定檔

確認以下設定是否正確：

1. **config.py** 中的設定：
   ```python
   SERVER_IP = "172.16.3.155"        # 第 17 行
   SHARED_FOLDER = "GEMINI TEST2"    # 第 20 行（注意有空格）
   ```

2. **啟動系統.bat** 中的帳號密碼：
   ```batch
   net use \\172.16.3.155\IPC$ /user:test 0508
   ```
   如果伺服器帳號密碼不同，請修改為正確的值

#### 步驟 4：常見問題排除

- **問題：ping 不通**
  - 檢查平板和伺服器是否在同一網路（同一個網段）
  - 檢查防火牆設定
  - 確認伺服器 IP 是否正確

- **問題：連線建立失敗**
  - 確認帳號密碼正確
  - 確認伺服器的網路共用已啟用
  - 確認伺服器允許此帳號連線

- **問題：共享資料夾無法存取**
  - 確認共享資料夾名稱正確（注意大小寫和空格）
  - 確認帳號有存取權限
  - 使用 `net view \\172.16.3.155` 查看實際的共享資料夾名稱

- **問題：路徑格式錯誤**
  - Windows 網路路徑格式：`\\IP\共享資料夾名稱`
  - 如果共享資料夾名稱有空格，必須用引號包起來：`"\\172.16.3.155\GEMINI TEST2"`

### 問題 2：無法讀取磅秤數據

**症狀**：重量顯示為 0 或「連線失敗」

**解決方法**：
1. 確認 `config.py` 中的 `SCALE_PORT` 設定正確
2. 確認磅秤已正確連接並開啟電源
3. 確認 COM Port 沒有被其他程式佔用
4. 檢查裝置管理員中的 COM Port 編號

### 問題 3：資料不同步

**症狀**：平板顯示的資料與伺服器不一致

**解決方法**：
1. 確認所有設備都連接到同一個伺服器共享資料夾
2. 重新啟動 Streamlit 應用程式（按 `Ctrl+C` 停止，然後重新啟動）
3. 確認網路連線穩定

---

## 📝 檢查清單

部署前請確認：

- [ ] Python 3.8+ 已安裝
- [ ] 所有必要的 Python 套件已安裝
- [ ] 完整專案資料夾已複製到平板
- [ ] `config.py` 中的 `SCALE_PORT` 已設定為正確的 COM Port
- [ ] `config.py` 中的伺服器 IP 和共享資料夾名稱正確
- [ ] `啟動系統.bat` 中的帳號密碼正確（如需要）
- [ ] 網路連線正常，可以存取伺服器共享資料夾
- [ ] 磅秤已正確連接並開啟電源
- [ ] 測試啟動系統，確認可以正常運作

---

## 🔄 從 CSV 遷移到 SQL 資料庫（首次升級）

如果您的系統仍在使用 CSV 檔案，需要執行一次遷移：

### 遷移步驟（在伺服器端執行）

1. **備份現有資料**：將所有 CSV 檔案複製到備份資料夾
2. **執行遷移腳本**：
   ```bash
   python migrate_to_sql.py
   ```
3. **確認遷移結果**：檢查是否產生 `production_db.sqlite` 檔案
4. **測試系統**：啟動系統確認資料正常顯示
5. **保留 CSV 備份**：建議保留 CSV 檔案作為備份，確認系統穩定運作後再考慮刪除

> **注意**：遷移只需執行一次，之後系統會自動使用 SQL 資料庫。

---

## 🔄 更新系統

當伺服器端的系統更新時：

1. **伺服器端**：更新所有程式檔案
2. **平板端**：只需要更新以下檔案（不需要更新資料庫檔案）：
   - `main.py` 或 `main_refactored.py`
   - `config.py`（注意保留每台平板的 COM Port 設定）
   - `data_manager.py`
   - `data_loader.py`
   - `db_schema.py`（SQL 資料庫結構）
   - `ui_styles.py`
   - `pages/` 資料夾內的所有檔案
   - `啟動系統.bat`（如有更新）

**重要**：更新 `config.py` 時，請記得保留每台平板的 `SCALE_PORT` 設定！



